<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Redis 6 Stream消息队列"><meta name="keywords" content="Redis"><meta name="author" content="YN"><meta name="copyright" content="YN"><title>Redis 6 Stream消息队列 | uwupu Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="uwupu Blog" type="application/atom+xml">
<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');loadCss('https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1');</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"></noscript></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Stream%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">Stream消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Stream%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">Stream结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.</span> <span class="toc-text">生产者命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%BB%84%E6%B6%88%E8%B4%B9"><span class="toc-number">1.3.</span> <span class="toc-text">消费组消费</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.</span> <span class="toc-text">使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BB%84-x2F-%E6%9F%A5%E8%AF%A2%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">创建组/查询信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%BB%84"><span class="toc-number">1.4.2.</span> <span class="toc-text">消费组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.</span> <span class="toc-text">一些命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XGROUP-%E7%BB%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.1.</span> <span class="toc-text">XGROUP 组操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XGROUP-CREATE-%E5%88%9B%E5%BB%BA%E7%BB%84"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">XGROUP CREATE 创建组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XGROUP-DESTROY-%E5%88%A0%E9%99%A4%E7%BB%84"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">XGROUP DESTROY 删除组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XGROUP-SETID-%E8%AE%BE%E7%BD%AE%E7%BB%84%E7%9A%84%E6%B6%88%E8%B4%B9id"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">XGROUP SETID 设置组的消费id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XGROUP-CREATECONSUMER-%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">XGROUP CREATECONSUMER  创建消费者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XGROUP-DELCONSUMER-%E5%88%A0%E9%99%A4%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.5.1.5.</span> <span class="toc-text">XGROUP DELCONSUMER 删除消费者</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XINFO-%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.2.</span> <span class="toc-text">XINFO 信息查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XINFO-CONSUMERS"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">XINFO CONSUMERS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XINFO-GROUPS"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">XINFO GROUPS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XINFO-STREAM"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">XINFO STREAM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.3.</span> <span class="toc-text">消费者操作</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">YN</div><div class="author-info__description text-center">一个包含有学习日记的博客</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://uwupu.tk/">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">99</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">24</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://uwupu.tk/">uwupuBlog</a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">uwupu Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">诶嘿</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">Redis 6 Stream消息队列</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-09-23</time><span class="post-meta__separator">|</span><span class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.4k</span><span class="post-meta__separator">|</span><span>阅读时长: 10 分钟</span></span></div><div class="article-container" id="post-content"><h1 id="Stream消息队列"><a href="#Stream消息队列" class="headerlink" title="Stream消息队列"></a>Stream消息队列</h1><p><a target="_blank" rel="noopener" href="https://pdai.tech/md/db/nosql-redis/db-redis-data-type-stream.html">https://pdai.tech/md/db/nosql-redis/db-redis-data-type-stream.html</a></p>
<p>Stream是一个新的强大的支持多播的可持久化的消息队列。</p>
<h2 id="Stream结构"><a href="#Stream结构" class="headerlink" title="Stream结构"></a>Stream结构</h2><p><img src="/2022/09/23/Redis-6/Stream%E7%BB%93%E6%9E%84.drawio.svg" alt="Stream结构.drawio"></p>
<p>consumer Group：消费组，使用XGROUP CREATE创建，一个消费组有多个消费者，这些消费者之间是竞争关系；</p>
<p>last_delivered_id：游标，每个消费组会有个游标last_delivered_id，任意一个消费者读取了消息都会使游标last_delivered_id往前移动；</p>
<p>Pending Entries List：pending_ids。维护并存放<strong>消费者读取消息的状态（消费者是否已经向服务器回应ACK）</strong>；pending_ids记录了当前已被客户端读取的消息，但还没有ack的消息；一旦某个消息被ack，这个队列会将消息id移除，表示消费者收到了该消息；用于确保客户端消费了消息一次，而不是在网络传输途中丢失了没处理。</p>
<p><strong>消息ID</strong>：即Stream创建Entry时会生成的ID。</p>
<ul>
<li>格式：timestampInMillis-sequence   12345567-9  毫米时间戳-序号；</li>
<li>序号为在同一时间戳内生成的消息的序号，用于区分在同一时间戳生成的多个消息；</li>
<li>格式必须为 <code>整数-整数</code>，后面加入的消息ID必须大于前面的消息ID；</li>
</ul>
<p><strong>消息内容</strong>：消息内容就是Entry的键值对；</p>
<h2 id="生产者命令"><a href="#生产者命令" class="headerlink" title="生产者命令"></a>生产者命令</h2><p><strong>XADD</strong>：添加消息到末尾；</p>
<p><strong>XTRIM</strong>：对流进行修剪；</p>
<p><strong>XDEL</strong>：删除消息；</p>
<p><strong>XLEN</strong>：获取流包含的元素数量；</p>
<p><strong>XRANGE</strong>：获取消息列表；</p>
<p>xxxxxxxxxx&nbsp;http { &nbsp; &nbsp;include &nbsp; &nbsp; &nbsp; mime.types; &nbsp; &nbsp;default_type &nbsp;application/octet-stream;    upstream yupstream{        # 服务器资源        server 127.0.0.1:8080 weight=1; &nbsp; # 权重为1        server 127.0.0.1:8081 weight=1;    }            server{        listen  801;        server_name localhost;        # 代理​​​        # 根目录请求        location / {                root html;                index index.html,index.htm;                proxy_pass <a target="_blank" rel="noopener" href="http://yupstream/">http://yupstream</a>; &nbsp; # 反向代理        }        location /admin {                }            }​}​perl</p>
<p><strong>XREAD</strong>：以阻塞或非阻塞方式获取消息列表。</p>
<h2 id="消费组消费"><a href="#消费组消费" class="headerlink" title="消费组消费"></a>消费组消费</h2><p><img src="/2022/09/23/Redis-6/%E6%B6%88%E8%B4%B9%E7%BB%84%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%84%E7%BB%84.drawio.svg" alt="消费组消费结构组.drawio"></p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>XGROUP CREATE 创建消费者组</p>
<p>XREADGROUP GROUP 读取消费组中的消息</p>
<p>XACK 将消息标记为已处理</p>
<p>XGROUP SETID 为消费者组设置新的最后递送消息ID</p>
<p>XGROUP DELCONSUMER 删除消费者</p>
<p>XGROUP DESTROY 删除消费者组</p>
<p>XPENDING 显示待处理消息的相关信息</p>
<p>XCLAIM 转移消息的归属权</p>
<p>XINFO 查看流和消费者组的相关信息</p>
<p>XINFO GROUPS 查询组信息</p>
<p>XINFO STREAM 打印流信息</p>
<p>XINFO CONSUMERS 组成员信息</p>
<h3 id="创建组-x2F-查询信息"><a href="#创建组-x2F-查询信息" class="headerlink" title="创建组/查询信息"></a>创建组/查询信息</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xadd st1 * apple 1 banana 23</span><br><span class="line">"1664179267483-0"</span><br><span class="line">127.0.0.1:6379&gt; xadd st1 * apple 12 banana 2 # 为st1添加两个消息</span><br><span class="line">"1664179271399-0"</span><br><span class="line">127.0.0.1:6379&gt; xgroup create st1 g1 0-0 # 为st1创建一个消费者组g1，从0-0开始消费</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; xgroup create st1 g2 $ # 为st1创建一个消费者组g2，仅获取最新的消息</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; xinfo stream st1  # 获取st1的stream信息</span><br><span class="line"> 1) "length"</span><br><span class="line"> 2) (integer) 2  # 长度</span><br><span class="line"> 3) "radix-tree-keys"</span><br><span class="line"> 4) (integer) 1</span><br><span class="line"> 5) "radix-tree-nodes"</span><br><span class="line"> 6) (integer) 2</span><br><span class="line"> 7) "last-generated-id"</span><br><span class="line"> 8) "1664179271399-0" # 最后生成的id</span><br><span class="line"> 9) "max-deleted-entry-id"</span><br><span class="line">10) "0-0"</span><br><span class="line">11) "entries-added"</span><br><span class="line">12) (integer) 2</span><br><span class="line">13) "recorded-first-entry-id"</span><br><span class="line">14) "1664179267483-0"</span><br><span class="line">15) "groups"</span><br><span class="line">16) (integer) 2</span><br><span class="line">17) "first-entry"  # 第一个entry</span><br><span class="line">18) 1) "1664179267483-0"</span><br><span class="line">    2) 1) "apple"</span><br><span class="line">       2) "1"</span><br><span class="line">       3) "banana"</span><br><span class="line">       4) "23"</span><br><span class="line">19) "last-entry"  # 最后一个entry</span><br><span class="line">20) 1) "1664179271399-0"</span><br><span class="line">    2) 1) "apple"</span><br><span class="line">       2) "12"</span><br><span class="line">       3) "banana"</span><br><span class="line">       4) "2"</span><br><span class="line">127.0.0.1:6379&gt; xinfo groups st1 #获取st1的组信息</span><br><span class="line">1)  1) "name"</span><br><span class="line">    2) "g1"</span><br><span class="line">    3) "consumers"</span><br><span class="line">    4) (integer) 0</span><br><span class="line">    5) "pending"</span><br><span class="line">    6) (integer) 0</span><br><span class="line">    7) "last-delivered-id"</span><br><span class="line">    8) "0-0"</span><br><span class="line">    9) "entries-read"</span><br><span class="line">   10) (nil)</span><br><span class="line">   11) "lag"</span><br><span class="line">   12) (integer) 2</span><br><span class="line">2)  1) "name"</span><br><span class="line">    2) "g2"</span><br><span class="line">    3) "consumers"</span><br><span class="line">    4) (integer) 0</span><br><span class="line">    5) "pending"</span><br><span class="line">    6) (integer) 0</span><br><span class="line">    7) "last-delivered-id"</span><br><span class="line">    8) "1664179271399-0"</span><br><span class="line">    9) "entries-read"</span><br><span class="line">   10) (nil)</span><br><span class="line">   11) "lag"</span><br><span class="line">   12) (integer) 0</span><br></pre></td></tr></tbody></table></figure>

<h3 id="消费组"><a href="#消费组" class="headerlink" title="消费组"></a>消费组</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">消费者消费数据  xreadgroup group 组名 消费者名 count 数量 streams steam名</span></span><br><span class="line">127.0.0.1:6379&gt; xreadgroup group g1 consumer001 count 1 streams st1 &gt;</span><br><span class="line">1) 1) "st1"</span><br><span class="line">   2) 1) 1) "1664179267483-0"</span><br><span class="line">         2) 1) "apple"</span><br><span class="line">            2) "1"</span><br><span class="line">            3) "banana"</span><br><span class="line">            4) "23"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">消费者consumer001再次从流st1、组g1消费一个数据</span></span><br><span class="line">127.0.0.1:6379&gt; xreadgroup group g1 consumer001 count 1 streams st1 &gt;</span><br><span class="line">1) 1) "st1"</span><br><span class="line">   2) 1) 1) "1664179271399-0"</span><br><span class="line">         2) 1) "apple"</span><br><span class="line">            2) "12"</span><br><span class="line">            3) "banana"</span><br><span class="line">            4) "2"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">st1中已经没有数据，再次读取返回nil</span></span><br><span class="line">127.0.0.1:6379&gt; xreadgroup group g1 consumer001 count 1 streams st1 &gt;</span><br><span class="line">(nil)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">尝试带阻塞读取数据</span>  </span><br><span class="line">127.0.0.1:6379&gt; xreadgroup group g1 consumer001 block 0 count 1 streams st1 &gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处阻塞</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在另一个终端向st1中添加数据后取消阻塞</span></span><br><span class="line">1) 1) "st1"</span><br><span class="line">   2) 1) 1) "1664179863235-0"</span><br><span class="line">         2) 1) "apple"</span><br><span class="line">            2) "12"</span><br><span class="line">            3) "qwe"</span><br><span class="line">            4) "11"</span><br><span class="line">(17.78s)  # 等待时间</span><br><span class="line">127.0.0.1:6379&gt; xinfo groups st1  # 获取st1的组信息</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">包含 组名，消费者数量，获取的数量等数据</span></span><br><span class="line">1)  1) "name"</span><br><span class="line">    2) "g1"</span><br><span class="line">    3) "consumers"</span><br><span class="line">    4) (integer) 1</span><br><span class="line">    5) "pending"</span><br><span class="line">    6) (integer) 3</span><br><span class="line">    7) "last-delivered-id"</span><br><span class="line">    8) "1664179863235-0"</span><br><span class="line">    9) "entries-read"</span><br><span class="line">   10) (integer) 3</span><br><span class="line">   11) "lag"</span><br><span class="line">   12) (integer) 0</span><br><span class="line">2)  1) "name"</span><br><span class="line">    2) "g2"</span><br><span class="line">    3) "consumers"</span><br><span class="line">    4) (integer) 0</span><br><span class="line">    5) "pending"</span><br><span class="line">    6) (integer) 0</span><br><span class="line">    7) "last-delivered-id"</span><br><span class="line">    8) "1664179271399-0"</span><br><span class="line">    9) "entries-read"</span><br><span class="line">   10) (nil)</span><br><span class="line">   11) "lag"</span><br><span class="line">   12) (nil)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取组g1的流st1的消费者数据</span></span><br><span class="line">127.0.0.1:6379&gt; xinfo consumers st1 g1</span><br><span class="line">1) 1) "name"</span><br><span class="line">   2) "consumer001"  # 消费者名</span><br><span class="line">   3) "pending"</span><br><span class="line">   4) (integer) 3  # 未处理的数据</span><br><span class="line">   5) "idle"</span><br><span class="line">   6) (integer) 61034</span><br><span class="line">127.0.0.1:6379&gt; xack st1 g1 1664179271399-0  # 使用ack表示数据已消费</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; xinfo consumers st1 g1 # 查看st1 g1下的消费者数据</span><br><span class="line">1) 1) "name"</span><br><span class="line">   2) "consumer001"</span><br><span class="line">   3) "pending"</span><br><span class="line">   4) (integer) 2  # 未处理的数据减少了</span><br><span class="line">   5) "idle"</span><br><span class="line">   6) (integer) 325172</span><br><span class="line">127.0.0.1:6379&gt; xack st1 g1 1664179863235-0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; xack st1 g1 1664179267483-0 # 将剩余的数据进行消费</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; xinfo consumers st1 g1 # 再次查询</span><br><span class="line">1) 1) "name"</span><br><span class="line">   2) "consumer001"</span><br><span class="line">   3) "pending"</span><br><span class="line">   4) (integer) 0  # 没有数据需要处理了</span><br><span class="line">   5) "idle"</span><br><span class="line">   6) (integer) 382595</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="一些命令"><a href="#一些命令" class="headerlink" title="一些命令"></a>一些命令</h2><h3 id="XGROUP-组操作"><a href="#XGROUP-组操作" class="headerlink" title="XGROUP 组操作"></a>XGROUP 组操作</h3><h4 id="XGROUP-CREATE-创建组"><a href="#XGROUP-CREATE-创建组" class="headerlink" title="XGROUP CREATE 创建组"></a>XGROUP CREATE 创建组</h4><p><code>XGROUP CREATE key groupname &lt;id | $&gt; [MKSTREAM] [ENTRIESTREAD entries_read]</code></p>
<p>为key创建一个消费者组，名为groupname；</p>
<p>每个组的名字在同一个key里是惟一的；若尝试创建一个已经存在的组，会返回错误</p>
<p>参数：</p>
<p><code>&lt;id | $&gt;</code>：从什么开始消费，其中id为指定id，$只接受新的消息，如：</p>
<ul>
<li>123-1 为从id为123-1的节点开始；</li>
<li>0-0 为<strong>从头开始</strong>；</li>
<li>$，只接受<strong>新的消息</strong>。</li>
</ul>
<p><strong>MKSTREAM</strong>：添加这个参数后，若指定流不存在，不再返回错误，而是创建名为key的流；</p>
<p><strong>ENTRIESREAD</strong>：hole…</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xadd st2 123-2 apple 3 stone 5  # 为st2添加数据（一般不用指定id，这里仅学习使用）</span><br><span class="line">"123-2"</span><br><span class="line">127.0.0.1:6379&gt; xadd st2 * apple 3 stone 123 # 为st2添加数据，id为自动生成，目前st2的最大id就是下面这个了</span><br><span class="line">"1664183965455-0"</span><br><span class="line">127.0.0.1:6379&gt; xgroup create st2 cg1 $ # 创建一个消费者组，指定$表示获取最新数据</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; xinfo groups st2</span><br><span class="line">1)  1) "name"</span><br><span class="line">    2) "cg1"</span><br><span class="line">    3) "consumers"</span><br><span class="line">    4) (integer) 0</span><br><span class="line">    5) "pending"</span><br><span class="line">    6) (integer) 0</span><br><span class="line">    7) "last-delivered-id"</span><br><span class="line">    8) "1664183965455-0" # 使用</span><br><span class="line">    9) "entries-read"</span><br><span class="line">   10) (nil)</span><br><span class="line">   11) "lag"</span><br><span class="line">   12) (integer) 0</span><br></pre></td></tr></tbody></table></figure>



<h4 id="XGROUP-DESTROY-删除组"><a href="#XGROUP-DESTROY-删除组" class="headerlink" title="XGROUP DESTROY 删除组"></a>XGROUP DESTROY 删除组</h4><p><code>XGROUP DESTROY key groupname</code></p>
<p>完全删除一个消费者组；</p>
<p>不论消费者组中是否存在<strong>活跃的消费者</strong>或是<strong>未处理的数据</strong>，会<strong>直接将消费者组删除</strong>；</p>
<p>返回成功删除的消费者组的数量</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xgroup create st1 cg1 0-0 # 创建消费者组，名为cg1，绑定的流为st1，起点0-0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; xgroup destroy st1 cg1 # 删除消费者组，名为cg1，绑定的流为st1</span><br><span class="line">(integer) 1</span><br></pre></td></tr></tbody></table></figure>

<h4 id="XGROUP-SETID-设置组的消费id"><a href="#XGROUP-SETID-设置组的消费id" class="headerlink" title="XGROUP SETID 设置组的消费id"></a>XGROUP SETID 设置组的消费id</h4><p><code>XGROUP SETID key groupname &lt;id | $&gt; [ENTRIESREAD entries_read]</code></p>
<p>设置消费者组要获取数据的起点id；</p>
<p>ENTRIESREAD：hole…</p>
<h4 id="XGROUP-CREATECONSUMER-创建消费者"><a href="#XGROUP-CREATECONSUMER-创建消费者" class="headerlink" title="XGROUP CREATECONSUMER  创建消费者"></a>XGROUP CREATECONSUMER  创建消费者</h4><p><code>XGROUP CREATECONSUMER key groupname consumername</code></p>
<p>创建一个消费者，key为流的名字，groupname为组的名字，consumername为消费者的名字；</p>
<p>可以使用XREADGROUP进行数据消费；</p>
<p>返回值为1或0，表示消费者是否被成功创建</p>
<h4 id="XGROUP-DELCONSUMER-删除消费者"><a href="#XGROUP-DELCONSUMER-删除消费者" class="headerlink" title="XGROUP DELCONSUMER 删除消费者"></a>XGROUP DELCONSUMER 删除消费者</h4><p><code>XGROUP DELCONSUMER key groupname consumername</code></p>
<p>删除消费者，key为流的名字，groupname为组的名字，consumername为消费者的名字；</p>
<h3 id="XINFO-信息查询"><a href="#XINFO-信息查询" class="headerlink" title="XINFO 信息查询"></a>XINFO 信息查询</h3><h4 id="XINFO-CONSUMERS"><a href="#XINFO-CONSUMERS" class="headerlink" title="XINFO CONSUMERS"></a>XINFO CONSUMERS</h4><p><code>XINFO CONSUMERS key groupname</code></p>
<p>返回绑定key的消费者组下的消费者信息；</p>
<h4 id="XINFO-GROUPS"><a href="#XINFO-GROUPS" class="headerlink" title="XINFO GROUPS"></a>XINFO GROUPS</h4><p><code>XINFO GROUPS key</code></p>
<p>返回绑定key的所有消费者组；</p>
<h4 id="XINFO-STREAM"><a href="#XINFO-STREAM" class="headerlink" title="XINFO STREAM"></a>XINFO STREAM</h4><p><code>XINFO STREAM key [FULL [COUNT count]]</code></p>
<p>返回流的信息；</p>
<p>信息包含：</p>
<ul>
<li>length：流中实体的数量；</li>
<li>radix-tree-keys：</li>
<li>radix-tree-nodes：</li>
<li>groups：定义在流中消费者组的数量</li>
<li>last-generated-id：最后一个实体使用的id；</li>
<li>max-deleted-entry-id：流中删除的最大id的条目；</li>
<li>entries-added：在流存活期间，所有添加过的实体的数量；</li>
<li>first-entry：第一个entry的信息；</li>
<li>last-entry：最后一个entry的信息。</li>
</ul>
<p>可选参数：</p>
<ul>
<li>FULL：将返回更多的信息；<ul>
<li>对于entries属性，以升序<strong>全部</strong>或<strong>指定数量</strong>的实体信息；</li>
<li>对于groups属性，包括XINFO GROUPS和XINFO CONSUMERS返回的信息。</li>
</ul>
</li>
<li>COUNT：指定FULL中返回实体的数量</li>
</ul>
<h3 id="消费者操作"><a href="#消费者操作" class="headerlink" title="消费者操作"></a>消费者操作</h3><p><code>XPENDING key group [[IDLE min-idle-time] start end count [consumer]]</code></p>
<p>获取消费组内<strong>被读取但未处理完毕</strong>的信息；</p>
<p>应用场景：为了解决组内数据被读取但在处理期间消费者<strong>崩溃</strong>的问题。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">YN</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://zswh33.github.io/2022/09/23/Redis-6/">http://zswh33.github.io/2022/09/23/Redis-6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://zswh33.github.io">uwupu Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/09/26/Nginx-2/"><i class="fa fa-chevron-left">  </i><span>Nginx 2</span></a></div><div class="next-post pull-right"><a href="/2022/09/22/Redis-5/"><span>Redis 5 HyperLogLogs Bitmaps  Geospatial</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">©2019 - 2023 By YN</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">哇！感谢你来到这个Blog，虽然没有什么内容...嗯..</div><div class="busuanzi"><script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/bundle.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>